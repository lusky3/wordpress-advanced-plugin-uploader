name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 6 * * 1' # Weekly on Monday at 06:00 UTC

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  composer-audit:
    name: Composer Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          tools: composer
          coverage: none

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run Composer audit
        run: composer audit --format=plain

  security-sniffs:
    name: WordPress VIP Security Sniffs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          tools: cs2pr, composer
          coverage: none

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Install PHPCS and security sniffs
        run: |
          composer global require --dev \
            squizlabs/php_codesniffer \
            automattic/vipwpcs \
            phpcompatibility/phpcompatibility-wp \
            dealerdirect/phpcodesniffer-composer-installer

      - name: Run PHPCS with WordPress VIP security sniffs
        run: |
          ~/.composer/vendor/bin/phpcs \
            --standard=WordPress-VIP-Go \
            --extensions=php \
            --ignore=vendor/,tests/,node_modules/ \
            --report=checkstyle \
            -q \
            includes/ bulk-plugin-installer.php | cs2pr
        continue-on-error: true

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: php
          queries: security-and-quality

      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: '/language:php'
