name: Security

on:
  push:
    branches: [main]
    paths:
      - '**.php'
      - 'composer.*'
      - '.github/workflows/security.yml'
  pull_request:
    branches: [main]
    paths:
      - '**.php'
      - 'composer.*'
      - '.github/workflows/security.yml'
  schedule:
    - cron: '0 6 * * 1' # Weekly on Monday at 06:00 UTC

permissions: {}

jobs:
  composer-audit:
    name: Composer Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          tools: composer
          coverage: none

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run Composer audit
        run: composer audit --format=plain

  security-sniffs:
    name: WordPress VIP Security Sniffs
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          tools: cs2pr, composer
          coverage: none

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Allow PHPCS Composer installer plugin globally
        run: composer global config --no-plugins allow-plugins.dealerdirect/phpcodesniffer-composer-installer true

      - name: Install PHPCS and security sniffs
        run: |
          composer global require --dev \
            squizlabs/php_codesniffer \
            automattic/vipwpcs \
            phpcompatibility/phpcompatibility-wp \
            dealerdirect/phpcodesniffer-composer-installer

      - name: Run PHPCS with WordPress VIP security sniffs
        run: |
          ~/.composer/vendor/bin/phpcs \
            --standard=WordPress-VIP-Go \
            --extensions=php \
            --ignore=vendor/,tests/,node_modules/ \
            --report=checkstyle \
            -q \
            includes/ bulk-plugin-installer.php | cs2pr
        continue-on-error: true

  gitguardian:
    name: GitGuardian Secret Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: github.event_name != 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: GitGuardian scan
        if: env.GITGUARDIAN_API_KEY != ''
        uses: GitGuardian/ggshield-action@v1
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

  snyk:
    name: Snyk Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          tools: composer
          coverage: none

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run Snyk to check for vulnerabilities
        if: env.SNYK_TOKEN != ''
        uses: snyk/actions/php@master
        with:
          args: --severity-threshold=high
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  sonarqube:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: SonarQube Scan
        if: env.SONAR_TOKEN != '' && env.SONAR_HOST_URL != ''
        uses: SonarSource/sonarqube-scan-action@v7
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
